# 麻雀AIプログラム仕様書

## 1. プロジェクト概要

### 1.1 プロジェクト名

- **名称**: MahjongAI

### 1.2 目的

- **主目的**: 段階的な開発手法を用いて、最終的に人間と対戦可能な麻雀AIを作成する
- **副次的目的**: AI・機械学習技術の段階的な学習と実装

### 1.3 開発スケジュール

| フェーズ | 内容 |
|---------|------|------|
| Phase 1 | CUI版1人用麻雀（索子のみ） |
| Phase 2 | Webアプリケーション化 |
| Phase 3 | 2人用麻雀への拡張 |
| Phase 4 | 簡易AI実装 |
| Phase 5 | 4人用麻雀への拡張 |
| Phase 6 | AI高度化 |

### 1.4 開発環境

- **OS**: Windows11,WSL
- **開発言語**: Python3.11
- **バージョン管理**: GitHub
- **IDE/エディタ**: VSCode

## 2. 技術仕様

### 2.1 システムアーキテクチャ

- **アーキテクチャパターン**: MVC（Model-View-Controller）
- **デザインパターン**: State, Template Method, Strategy, Command, Observer, Factory

### 2.2 技術スタック

#### バックエンド

- **言語**: Python 3.11
- **フレームワーク**: Flask
- **ライブラリ**:
  - Web関連: Flask-CORS, Flask-RESTful
  - データベース: SQLAlchemy, Flask-SQLAlchemy, Alembic
  - データ処理: marshmallow, numpy
  - 開発・テスト: pytest, pytest-cov, black, flake8, mypy
  - ユーティリティ: python-dotenv

#### フロントエンド（Phase 2以降）

- **言語**: TypeScript
- **フレームワーク**: React
- **UIライブラリ**: Ant Design, Framer Motion
- **状態管理**: Zustand
- **その他ライブラリ**: axios, react-router-dom, react-hook-form, TanStack Query

#### データベース

- **種類**: SQLite
- **用途**: 牌譜保存、AI学習データ蓄積

#### 通信

- **プロトコル**: HTTP (REST API)
- **リアルタイム通信**: なし（ローカル完結型）

## 3. Phase 1: CUI版1人用麻雀（索子のみ）

### 3.1 基本仕様

#### 3.1.1 使用牌

- **種類**: 索子のみ
- **数字**: 1〜9
- **枚数**: 各4枚（合計36枚）

#### 3.1.2 ゲーム設定

- **プレイヤー数**: 1人
- **初期手牌**: 13枚
- **和了形式**:
  - 4面子1雀頭（14枚）
  - 七対子（7つの対子）
- **ドラ**: 表示牌1枚（Phase 3から実装）

### 3.2 ルール定義

#### 3.2.1 基本ルール

- **ツモ**: 山牌から1枚引く
- **打牌**: 手牌から1枚選んで捨てる
- **和了条件**: 4面子1雀頭または七対子の完成
- **リーチ**: テンパイ時に宣言可能
- **カン**: 暗槓のみ実装（同じ牌4枚）

#### 3.2.2 特殊ルール

- **カン**: 暗槓のみ実装
  - カン後は嶺上牌をツモる
  - カンドラは実装しない
- **リーチ**: 実装する
  - リーチ後は自動ツモ切り
  - リーチ料は実装しない（点数なし）
- **その他**: 一発、裏ドラは実装しない

### 3.3 ゲームフロー

1. **初期化処理**
   - 山牌生成（索子1-9を各4枚）
   - シャッフル
   - 嶺上牌4枚を分離
   - 配牌（13枚）

2. **メインループ**
   - 山牌残数表示
   - ツモ（1枚）
   - 手牌表示（ソート済み）
   - ツモ和了判定
   - アクション選択
     - 打牌
     - カン（可能な場合）
     - リーチ（テンパイ時）
     - ツモ和了（和了時）

3. **終了条件**
   - 和了：成功メッセージ
   - 流局：山牌0枚（嶺上牌除く）

### 3.4 データ構造

#### 3.4.1 牌の表現方法

- **方式**: 辞書型オブジェクト
- **詳細**: {'suit': 'sou', 'value': 1-9}
- **内部表現**: 数値ID（0-135）も併用し、Phase 5への拡張に備える
- **識別子設計**: 索子:0-35、萬子:36-71、筒子:72-107、字牌:108-135

#### 3.4.2 手牌の管理

- **データ構造**: リスト（List[Tile]）
- **ソート方法**: value昇順
- **ソートタイミング**: 常時ソート状態を維持

#### 3.4.3 山牌の管理

- **データ構造**: リスト（List[Tile]）
- **シャッフル方法**: random.shuffle()

#### 3.4.4 捨て牌（河）の管理

- **データ構造**: リスト（List[Tile]）
- **表示方法**: 時系列順（古い順）
- **リーチ牌の識別**: 別途フラグ管理

### 3.5 主要機能

#### 3.5.1 和了判定

- **アルゴリズム**:
  - 通常形: 再帰的探索（雀頭選択→面子判定）
  - 七対子: 7つの対子の確認
- **計算量**: O(n^2)程度（n=14）

#### 3.5.2 向聴数計算

- **実装**: する（リーチ判定に必要）
- **アルゴリズム**:
  - 通常形向聴数
  - 七対子向聴数
  - 最小値を採用

### 3.6 UI仕様（CUI）

#### 3.6.1 画面レイアウト

```
========================================
ターン: 10 | 残り山牌: 12枚 | 嶺上牌: 4枚
リーチ: OFF
========================================

あなたの捨て牌:
1索 2索 3索 4索 5索 6索 7索
8索 9索 1索 [2索] 3索 4索
（[]はリーチ宣言牌）

----------------------------------------

あなたの手牌:
[1] 1索  [2] 1索  [3] 2索  [4] 3索  [5] 4索
[6] 5索  [7] 6索  [8] 7索  [9] 8索  [10] 9索
[11] 9索  [12] 9索  [13] 9索

ツモ牌: [14] 3索

選択可能なアクション:
1. 打牌する（1-14の番号を入力）
2. カン（可能な場合のみ表示）
3. リーチ（テンパイ時のみ表示）
4. ツモ和了（和了時のみ表示）

アクションを選択してください: 
```

#### 3.6.2 操作方法

- **牌選択**: 数字入力（1-14）
- **アクション選択**: 対応する番号入力
- **決定**: Enter
- **キャンセル**: ―（実装しない）

### 3.7 エラー処理

- **不正入力**: エラーメッセージ表示後、再入力要求
- **システムエラー**: スタックトレース表示、プログラム終了
- **想定外の状態**: 5枚目の同じ牌等は検証して例外発生
- **復旧方法**: 可能な限りゲーム続行、致命的エラーのみ終了

### 3.8 デバッグ機能

- **デバッグモード**: 環境変数で有効化
- **機能**:
  - 全プレイヤーの手牌表示
  - 任意の牌姿から開始
  - AI思考過程の表示
  - 山牌の内容確認
  - 統計情報のリアルタイム表示

## 4. Phase 2: Webアプリケーション化

### 4.1 アーキテクチャ

- **通信方式**: REST API
- **認証方式**: なし（ローカル環境）

### 4.2 API設計

#### 4.2.1 エンドポイント

| メソッド | パス | 説明 |
|---------|------|------|
| POST | /api/game/new | 新規ゲーム開始 |
| GET | /api/game/{id}/state | ゲーム状態取得 |
| POST | /api/game/{id}/draw | ツモ |
| POST | /api/game/{id}/discard | 打牌 |
| POST | /api/game/{id}/kan | カン |
| POST | /api/game/{id}/riichi | リーチ |
| POST | /api/game/{id}/win | 和了 |

### 4.3 フロントエンド設計

#### 4.3.1 画面構成

- **ゲーム画面**: メイン画面
- **スタート画面**: ゲーム開始
- **結果画面**: 和了/流局時

#### 4.3.2 コンポーネント構成

- GameBoard（メインコンテナ）
  - PlayerHand（手牌表示）
  - DiscardArea（捨て牌表示）
  - GameInfo（ゲーム情報）
  - ActionButtons（アクション選択）
- TileComponent（牌コンポーネント）
- Modal（和了表示等）

### 4.4 状態管理

- **管理対象**:
  - ゲーム状態（gameId, turn, wallCount等）
  - 手牌、捨て牌、ツモ牌
  - アクション可否フラグ
  - UI状態
- **更新タイミング**: APIレスポンス受信時

### 4.5 UI/UX設計

#### 4.5.1 牌の表示

- **方式**: CSS/SVGで描画
- **サイズ**: PC画面用に最適化
- **アニメーション**: Framer Motion使用

#### 4.5.2 レイアウト

- 上部：ゲーム情報
- 中部：捨て牌エリア（6×3行）
- 下部：手牌とアクションボタン

#### 4.5.3 インタラクション

- マウスクリックで牌選択
- ホバーエフェクト実装
- キーボードショートカット対応（オプション）
- 基本的なアニメーション実装

#### 4.5.4 対応環境

- **ブラウザ**: Chrome（最新版）
- **画面解像度**: 1920×1080以上推奨
- **デバイス**: PCのみ（マウス操作前提）

## 5. Phase 3: 2人用麻雀への拡張

### 5.1 追加仕様

- **ポン**: 実装する（相手の捨て牌から対子を刻子に）
- **チー**: 実装しない
- **明槓**: 実装する（ポンした牌に追加、相手の捨て牌から直接）
- **点数計算**: 正式な点数計算を実装

### 5.2 点数計算システム

#### 5.2.1 実装する役

##### 1飜役

- **門前清自摸和（メンゼンツモ）**: 鳴きなしでツモ和了
- **立直（リーチ）**: テンパイ時に宣言
- **一発**: リーチ後1巡以内の和了
- **嶺上開花**: カン後の嶺上牌で和了
- **海底摸月（ハイテイ）**: 最後のツモで和了
- **河底撈魚（ホウテイ）**: 最後の捨て牌でロン
- **槍槓（チャンカン）**: 相手の加槓牌でロン
- **断么九（タンヤオ）**: 2-8の牌のみで構成
- **平和（ピンフ）**: 門前で符なしの和了形
- **一盃口（イーペーコー）**: 同じ順子2組

##### 2飜役

- **ダブル立直**: 1巡目でリーチ
- **七対子（チートイツ）**: 7つの対子
- **対々和（トイトイ）**: 4つの刻子
- **三暗刻**: 3つの暗刻
- **一気通貫（イッツー）**: 123・456・789の順子

##### 3飜役

- **二盃口（リャンペーコー）**: 一盃口を2組

##### 6飜役

- **清一色（チンイツ）**: 1種類の牌のみで構成

##### 役満

- **四暗刻**: 4つの暗刻
- **四暗刻単騎**: 四暗刻を単騎待ちで和了
- **三槓子**: 3つの槓子
- **四槓子**: 4つの槓子
- **九蓮宝燈**: 1112345678999+任意の同種牌

##### ドラ

- **ドラ**: 表示牌の次の牌1枚につき1飜
- **裏ドラ**: リーチ和了時、裏ドラ表示牌の次の牌
- **槓ドラ**: カンした時に追加されるドラ
- **槓裏ドラ**: リーチ和了時の槓ドラの裏

#### 5.2.2 符計算

- **基本符**: 20符
- **門前ロン**: +10符
- **ツモ**: +2符
- **刻子・槓子の符**:
  - 中張牌（2-8）刻子: 2符（明刻）/4符（暗刻）
  - 端牌（1,9）刻子: 4符（明刻）/8符（暗刻）
  - 中張牌槓子: 8符（明槓）/16符（暗槓）
  - 端牌槓子: 16符（明槓）/32符（暗槓）
- **雀頭**:
  - 数牌: 0符
  - 役牌（Phase 5以降）: 2符
  - 連風牌（Phase 5以降）: 4符
- **待ち**:
  - 両面待ち: 0符
  - 辺張・嵌張・単騎待ち: 2符
- **特殊形**:
  - 七対子: 25符固定
  - 平和ツモ: 20符固定

#### 5.2.3 得点計算

- **基本計算式**: 符×2^(飜数+2)
- **切り上げ**: 100点単位
- **満貫以上**:
  - 満貫（5飜）: 8000点
  - 跳満（6-7飜）: 12000点
  - 倍満（8-10飜）: 16000点
  - 三倍満（11-12飜）: 24000点
  - 役満: 32000点
- **2人麻雀**: ツモ・ロンともに相手から全額

#### 5.2.4 Phase 3での特記事項

- 清一色は常に成立するが、他の役との複合を楽しむ
- 例: リーチ・清一色・断么九で跳満

### 5.3 AI実装（簡易版）

#### 5.3.1 基本戦略

- **打牌選択**: 左端から順に捨てる
- **鳴き判断**:
  - ポン可能なら必ずポン
  - カン可能なら必ずカン
- **リーチ**: テンパイしたら即リーチ
- **和了**: 和了可能なら必ず和了

#### 5.3.2 実装方法

- Template Methodパターンを使用
- AbstractPlayerクラスを継承
- 各判断メソッドで固定的な動作を返す
- 手牌の整理や効率的な打牌選択は行わない

### 5.4 UI/UX拡張

#### 5.4.1 画面レイアウト

```
┌─────────────────────────────────┐
│     ゲーム情報・得点表示        │
├─────────────────────────────────┤
│   CPU/相手の捨て牌              │
│   CPU/相手の副露牌              │
├─────────────────────────────────┤
│      残り山牌数                 │
│      現在のプレイヤー           │
├─────────────────────────────────┤
│   自分の副露牌                  │
│   自分の捨て牌                  │
├─────────────────────────────────┤
│   自分の手牌                    │
│   アクション（ポン/カン/パス）  │
└─────────────────────────────────┘
```

#### 5.4.2 追加UI要素

- **得点表示**: 各プレイヤーの現在得点
- **副露表示**: ポン・カンした牌グループ
- **アクション通知**: 「ポンできます」等
- **結果表示**: 点数計算の詳細

### 5.5 ゲームフロー

1. **対戦開始**
   - 先手後手決定（ランダム）
   - 持ち点設定（25000点など）

2. **ゲーム進行**
   - 交互にツモ・打牌
   - CPU/相手の打牌後：
     - ポン/カン可能かチェック
     - 可能なら選択画面表示
     - タイムアウトなし（ローカル）

3. **和了処理**
   - 点数計算
   - 得点移動
   - 次局へ（連荘なし）

4. **終了条件**
   - 指定局数終了
   - どちらかが0点以下

## 6. Phase 4: 簡易AI実装

### 6.1 AI戦略

#### 6.1.1 基本戦略

- **打牌選択**: 向聴数を基準とした効率的な打牌
- **鳴き判断**: 役の確定や向聴数の大幅改善時のみ
- **リーチ判断**: 待ち牌の枚数と得点期待値で判断
- **防御**: 相手リーチ時の安全牌選択

#### 6.1.2 評価関数

- **手牌評価**: 向聴数、有効牌枚数、役の可能性
- **打牌評価**: 各牌を切った後の手牌価値
- **安全度評価**: 振り込みリスクの計算

### 6.2 難易度設定

| レベル | 説明 | 特徴 |
|--------|------|------|
| Easy | 初心者向け | ランダムに近い打牌、積極的な鳴き |
| Normal | 基本戦略 | 向聴数重視、バランスの良い打牌 |
| Hard | 上級戦略 | 役と効率の両立、相手の捨て牌読み |

### 6.3 実装範囲

#### 6.3.1 実装する機能

- 向聴数計算アルゴリズム
- 有効牌の判定
- 基本的な役の判定
- 状況に応じた戦略切り替え（Strategy パターン）
- 相手の捨て牌からの危険牌推測（Hard のみ）

#### 6.3.2 実装しない機能

- 期待値の詳細計算
- 機械学習
- 複雑な読み合い

### 6.4 デバッグ機能

- AI思考過程の可視化（開発モード）
- 統計情報の収集（和了率、平均得点等）

## 7. Phase 5: 4人用麻雀への拡張

### 7.1 追加要素

- **東南西北牌**: 追加する
- **白發中**: 追加する
- **萬子・筒子**: 追加する

### 7.2 役の実装

| 役名 | 飜数 | 実装優先度 |
|------|------|-----------|
| 役牌（白・發・中） | 1飜 | 高 |
| 役牌（自風・場風） | 1飜 | 高 |
| 三色同順 | 2飜 | 高 |
| 混全帯么九 | 2飜 | 中 |
| 小三元 | 2飜 | 中 |
| 混一色 | 3飜 | 高 |
| 純全帯么九 | 3飜 | 中 |
| 大三元 | 役満 | 中 |
| 国士無双 | 役満 | 高 |
| 字一色 | 役満 | 低 |
| 緑一色 | 役満 | 低 |
| 小四喜・大四喜 | 役満 | 低 |

### 7.3 点数計算

- **親の倍率**: 子の1.5倍
- **連荘**: 積み棒×300点
- **リーチ棒**: 1000点（和了者が獲得）
- **ツモ時の支払い**:
  - 子のツモ: 親2倍、子1倍
  - 親のツモ: 子全員から均等（オール）

### 7.4 ゲーム進行

- **局の進行**: 東1局〜東4局（〜南4局）
- **親の決定**: 起家から反時計回り
- **終了条件**: 規定局数終了 or 飛び（0点未満）

### 7.5 UI/UX拡張

- **4人配置**: 自分（下）、対面（上）、上家（右）、下家（左）
- **追加表示**: 各プレイヤーの点数、風、場、積み棒数
- **中央エリア**: ドラ表示、残り山牌数

### 7.6 AI拡張

- **4人対応**: 3人の相手を考慮した戦略
- **状況判断**: 親番戦略、オーラス戦略、順位意識

## 8. Phase 6: AI高度化

### 8.1 高度な戦略

#### 8.1.1 相手の手牌推測

- **方式**: 捨て牌分析、鳴き牌分析、リーチ分析
- **精度目標**: 危険牌予測70%以上、テンパイ認識80%以上

#### 8.1.2 期待値計算

- **計算対象**: 打牌選択、リーチ判断、鳴き判断
- **更新頻度**: ツモ後、他家打牌後、鳴き発生後

### 8.2 機械学習（オプション）

- **採用可否**: 採用する
- **学習方式**: 強化学習（自己対戦）
- **データ収集**: 全牌譜を自動保存、統計情報の蓄積

### 8.3 高度な局面判断

#### 8.3.1 押し引き判断

- **押し要因**: 高打点、親番、点差状況、良形待ち
- **引き要因**: 複数リーチ、危険察知、守備優先状況

#### 8.3.2 オーラス戦略

- **順位別**: 1位逃げ切り、2位条件攻撃、3位積極攻撃、4位一発逆転
- **点差計算**: 必要得点の自動計算、直撃・ツモ条件の把握

### 8.4 実装範囲

#### 8.4.1 前半実装

- 相手の捨て牌分析強化
- 期待値計算システム
- 押し引き判断の高度化
- データ収集基盤構築

#### 8.4.2 後半実装

- 強化学習システム
- 自己対戦環境
- 性能分析ツール
- AIパラメータ調整機能

### 8.5 性能目標

- **Easy AI**: 対人間勝率 20-30%
- **Normal AI**: 対人間勝率 40-50%
- **Hard AI**: 対人間勝率 60-70%
- **Expert AI**: 対人間勝率 70%以上（学習後）

## 9. テスト計画

### 9.1 単体テスト

- **カバレッジ目標**: 80%（コアロジックは95%以上）
- **テストフレームワーク**: pytest（バックエンド）、Jest（フロントエンド）
- **重点テスト対象**:
  - 和了判定ロジック
  - 役判定（全役網羅）
  - 点数計算
  - 向聴数計算

### 9.2 統合テスト

- **テスト項目**:
  - ゲームフロー全体の動作確認
  - Phase間の互換性確認
  - 100局連続プレイでの安定性
  - エラー復帰テスト
- **自動化**: CI/CDパイプラインで自動実行

### 9.3 性能テスト

- **レスポンスタイム目標**:
  - 和了判定: 10ms以内
  - AI思考: Easy 100ms、Normal 500ms、Hard 1000ms以内
  - API応答: 50ms以内
- **同時接続数**: 最小4ゲーム、目標100ゲーム
- **リソース使用**: CPU 70%以下、メモリ 2GB以下

## 10. 運用・保守

### 10.1 ログ

- **ログレベル**: Production(INFO以上)、Staging(DEBUG以上)、Development(すべて)
- **保存期間**: エラーログ90日、ゲームログ30日、デバッグログ7日
- **ローテーション**: 100MB または 日次

### 10.2 監視

- **監視項目**:
  - システムリソース（CPU、メモリ、ディスク）
  - アプリケーション（ゲーム数、応答時間、エラー率）
  - ゲームバランス（役出現率、AI勝率）
- **アラート条件**:
  - Critical: サーバーダウン、エラー率5%超
  - Warning: CPU80%超、ディスク90%超
  - Info: 日次・週次レポート

### 10.3 バックアップ

- **対象**: データベース、AIモデル、設定ファイル
- **頻度**: DB日次差分・週次フル、AIモデル学習完了時
- **保存期間**: ローカル7日、リモート30日、アーカイブ月次1年
- **リストア目標**: 1時間以内

## 11. セキュリティ

### 11.1 認証・認可

- **方式**: 認証なし（ローカル環境のため不要）
- **セッション管理**: ローカルストレージでゲーム状態管理

### 11.2 データ保護

- **暗号化**: 不要（ローカル環境、個人情報なし）
- **個人情報**: 収集しない（匿名の統計情報のみ）

### 11.3 アプリケーションセキュリティ

#### 11.3.1 入力検証

- **フロントエンド**: TypeScriptによる型チェック、範囲検証
- **バックエンド**: 全入力の検証、不正値の拒否

#### 11.3.2 脆弱性対策

- **XSS対策**: Reactのデフォルト保護機能
- **SQLインジェクション**: ORMによる自動エスケープ
- **依存関係**: npm auditの定期実行、脆弱性の監視

### 11.4 ゲームの公平性

- **ロジック**: すべてサーバー側で実行
- **乱数生成**: サーバー側で管理
- **情報制御**: 必要な情報のみクライアントに送信

### 11.5 ライセンス・コンプライアンス

- **オープンソース**: 使用ライブラリのライセンス遵守
- **素材**: 画像・音声の著作権確認
- **年齢制限**: なし（ギャンブル要素を含まない）

## 12. 制約事項

### 12.1 技術的制約

- **環境**: Windows 11 + WSL、Chrome最新版のみ対応
- **パフォーマンス**: AI思考最大1秒、メモリ2GB以下
- **機能**: ネットワーク機能なし、モバイル非対応、音声なし
- **同時実行**: 1ゲームのみ（複数タブ非対応）

### 12.2 リソース制約

- **開発期間**: 段階的実装（個人開発想定）
- **人員**: 1名想定
- **予算**: オープンソース・無料ツールのみ使用
- **データ**: ローカル環境のみ、自己対戦データのみ

### 12.3 ゲーム仕様の制約

- **ルール**: 標準ルールのみ、一部の特殊役・途中流局なし
- **UI/UX**: CSS/SVGベース、アニメーション最小限、日本語のみ
- **AI**: 学習に時間がかかる、人間のトップレベルには及ばない

### 12.4 拡張性の制約

- **アーキテクチャ**: 大規模変更困難
- **非対応**: プラグイン、MOD、外部API連携

### 12.5 品質の制約

- **テスト**: 単一環境のみ、網羅的テスト困難
- **既知の制限**: 特殊状況での不具合可能性、エラー時は手動リセット

## 13. 用語定義

| 用語 | 説明 |
|------|------|
| **牌（ハイ）** | 麻雀で使用する駒。萬子・筒子・索子・字牌の総称 |
| **手牌（テハイ）** | プレイヤーが持っている牌 |
| **面子（メンツ）** | 3枚1組の組み合わせ（順子または刻子） |
| **順子（シュンツ）** | 同じ種類の連続する3枚（例：123） |
| **刻子（コーツ）** | 同じ牌3枚の組み合わせ |
| **雀頭（ジャントウ）** | 同じ牌2枚の組み合わせ |
| **和了（ホーラ）** | 役を完成させて勝利すること |
| **聴牌（テンパイ）** | あと1枚で和了できる状態 |
| **向聴数（シャンテンスウ）** | 聴牌までに必要な最小交換枚数 |
| **ツモ** | 山牌から1枚引くこと |
| **ロン** | 他家の捨て牌で和了すること |
| **リーチ** | 聴牌を宣言する行為 |
| **ドラ** | ボーナス牌。1枚につき1飜追加 |
| **役（ヤク）** | 和了に必要な特定の牌の組み合わせ |
| **飜（ファン/ハン）** | 役の価値を表す単位 |
| **符（フ）** | 和了形の複雑さを表す単位 |
| **鳴き（ナキ）** | 他家の捨て牌を使って面子を作ること |
| **副露（フーロ）** | 鳴いて作った面子 |
| **門前（メンゼン）** | 鳴かずに手牌を進めること |
| **河（ホー）** | 各プレイヤーの捨て牌置き場 |
| **Phase** | 開発の段階（Phase 1〜6） |
| **CUI** | Character User Interface。文字ベースの操作画面 |
| **評価関数** | 局面の良さを数値化する関数 |
| **強化学習** | 試行錯誤を通じて最適な行動を学習する手法 |

## 14. 参考資料

- **日本麻雀連盟公式ルール**: 標準的なルールの参考
- **Python公式ドキュメント**: <https://docs.python.org/ja/3.11/>
- **Flask公式ドキュメント**: <https://flask.palletsprojects.com/>
- **React公式ドキュメント**: <https://react.dev/>
- **TypeScript公式ドキュメント**: <https://www.typescriptlang.org/docs/>
- **SQLAlchemy公式ドキュメント**: <https://www.sqlalchemy.org/>
- **向聴数計算アルゴリズムの解説**: 実装の参考
- **強化学習の入門資料**: AI高度化の参考
- **Git/GitHubの使い方**: バージョン管理の参考

### 14.1 ドキュメント整備

- **開発者向け**:
  - API仕様書（OpenAPI形式）
  - アーキテクチャ設計書
  - データベース設計書
  - デプロイメント手順
- **ユーザー向け**:
  - 操作マニュアル
  - 麻雀ルール説明
  - FAQ
  - トラブルシューティング
- **プロジェクト管理**:
  - コーディング規約
  - Git運用ルール
  - リリースノート
  - 既知の問題リスト### 11.6 アクセシビリティ
- **視覚的配慮**:
  - 色覚多様性対応（赤緑色盲に配慮した配色）
  - 高コントラストモード
  - フォントサイズの可変対応
- **操作性**:
  - キーボードのみでの完全操作
  - フォーカスの明確な表示
  - タブ順序の最適化
- **スクリーンリーダー**:
  - 基本的なaria-label対応
  - 重要な状態変化の通知
  - 代替テキストの提供### 10.4 バージョン管理
- **セーブデータ互換性**:
  - バージョン情報の埋め込み
  - 旧バージョンからの自動変換
  - 互換性のないバージョンの警告
- **マイグレーション**:
  - 設定ファイルの自動更新
  - データベーススキーマの移行
  - 変更履歴の記録
- **APIバージョニング**:
  - エンドポイントのバージョン管理
  - 非推奨APIの段階的廃止
  - 後方互換性の維持期間### 9.4 特殊なテスト
- **回帰テスト**: 各Phase完了時に全機能を再確認
- **境界値テスト**:
  - 0点、マイナス点の処理
  - 最大得点（役満12倍等）
  - 牌山0枚での動作
- **ストレステスト**:
  - 1000局連続実行
  - メモリリークの確認
  - パフォーマンス劣化の監視
- **ユーザビリティテスト**:
  - 実際のユーザーによる操作性評価
  - 初心者の理解度確認
  - フィードバックの収集### 4.8 学習・練習機能
- **練習モード**:
  - 牌効率表示（推奨打牌のヒント）
  - 詰め麻雀（特定局面からの練習）
  - 待ち牌当てクイズ
- **分析機能**:
  - プレイ統計（和了率、放銃率、平均得点）
  - 打牌傾向の分析
  - AIとの比較
- **リプレイ機能**:
  - 牌譜の再生
  - 任意の手番からの再開
  - 別の選択をした場合のシミュレーション### 4.7 ユーザー体験（UX）機能
- **操作補助**:
  - 誤操作防止（重要操作時の確認）
  - Undo機能（打牌の取り消し）※デバッグモードのみ
  - 待ち牌表示（初心者モード）
- **キーボードショートカット**:
  - 数字キー: 牌選択
  - Enter: 決定
  - R: リーチ
  - K: カン
  - Esc: キャンセル
- **視覚的フィードバック**:
  - ホバーエフェクト
  - 選択中の牌のハイライト
  - アニメーション完了待機### 3.9 ゲームの公平性
- **牌の配分**: 完全ランダム（crypto.randomを使用）
- **乱数シード**: 再現可能なゲームのためオプションでシード指定可能
- **イカサマ防止**: デバッグモード以外では山牌の中身を隠蔽### 12.6 将来的な拡張への考慮事項
- **プラグイン構造**: 現時点では実装しないが、役の追加を考慮した設計
- **UIテーマ**: CSS変数を使用し、将来的なテーマ切り替えに対応
- **多言語対応**: 文字列のハードコーディングを避け、定数として管理
- **ルールカスタマイズ**: ルールエンジンの分離を意識した実装### 8.6 性能最適化
- **向聴数計算**: 頻出パターンのキャッシュ化
- **AI思考**:
  - 探索深さの動的調整
  - 枝刈りによる高速化
- **メモリ管理**:
  - 牌譜は直近100局のみ保持
  - 古いデータの自動削除
- **レンダリング**:
  - 変更箇所のみ再描画
  - 仮想DOMの効率的利用### 4.6 設定・カスタマイズ
- **ゲーム設定**:
  - 持ち点（25000点等）
  - 東風戦/半荘戦
  - 赤ドラの有無（将来実装）
- **表示設定**:
  - 牌のサイズ（大/中/小）
  - 配色テーマ
  - アニメーション速度
- **AI設定**:
  - 思考時間（0.1秒〜3秒）
  - 難易度の詳細調整
- **保存方法**: ローカルストレージに JSON 形式で保存# 麻雀AIプログラム仕様書
